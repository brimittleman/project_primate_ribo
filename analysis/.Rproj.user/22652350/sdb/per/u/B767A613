{
    "contents" : "\n#load libraries\n\nlibrary(\"reshape2\", lib.loc=\"/Library/Frameworks/R.framework/Versions/3.2/Resources/library\")\nlibrary(\"ggplot2\", lib.loc=\"/Library/Frameworks/R.framework/Versions/3.2/Resources/library\")\nlibrary(\"dplyr\", lib.loc=\"/Library/Frameworks/R.framework/Versions/3.2/Resources/library\")\nlibrary(\"Biobase\")\nlibrary(\"gdata\", lib.loc=\"/Library/Frameworks/R.framework/Versions/3.2/Resources/library\")\nlibrary(\"limma\")\n\n#load data\n\nload(\"../rdas/HRC.plus.mm4H.ribo.rda\")\nload(\"../rdas/mm4.ribo.rda\")\nload(\"../rdas/HCR.ortho.geneLength.rda\")\nload(\"/Users/siddisis/Dropbox/work/Ribosome_profiling/Primate_comparison/manuscript/data/rdas/eSetRRP.rda\")\nYRI.ribo.logCPM<-read.csv(\"~/Dropbox/work/Ribosome_profiling/Primate_comparison/Enrichment_analysis/battle_etal_ribo_logCPM_data.csv\")\n\n# log rpkm\n\n#YRI\nYRI.ribo.logCPM[,77]->ribo.length\n(YRI.ribo.logCPM[,2:73]-log2(ribo.length/1000))->YRI.ribo.logRPKM\nYRI.ribo.logRPKM$ENSG <-YRI.ribo.logCPM$ENSG\n\n# primate data 1\nHRC.plus.mm4H.rpkm.speLength <- prop.table(as.matrix(HRC.plus.mm4H.ribo[,-1]),2)*10^9\nHRC.plus.mm4H.rpkm.speLength <- cbind(HRC.plus.mm4H.rpkm.speLength[,1:5]/HCR.geneLength$Chimp,HRC.plus.mm4H.rpkm.speLength[,6:11]/HCR.geneLength$Human,HRC.plus.mm4H.rpkm.speLength[,12:16]/HCR.geneLength$Rhesus,HRC.plus.mm4H.rpkm.speLength[,17:20]/HCR.geneLength$Human)\n\nmm4.rpkm.speLength <- prop.table(as.matrix(mm4.ribo[,-1]),2)*10^9\nmm4.rpkm.speLength<-cbind(mm4.rpkm.speLength[,1:4]/HCR.geneLength$Chimp, mm4.rpkm.speLength[,5:8]/HCR.geneLength$Rhesus, mm4.rpkm.speLength[,9:12]/HCR.geneLength$Human)\n\n\n#HRC.plus.mm4H.rpkm.speLength<-cbind(HRC.plus.mm4H.ribo[,1],as.data.frame(HRC.plus.mm4H.rpkm.speLength))\n\n\nrpkm.filter<-c() \nfor (i in 1:length(mm4.rpkm.speLength[,1])){\n  rpkm.filter[i]<-sum(mm4.rpkm.speLength[i,] == 0) < 7\n}\n\n#ENSG<-HRC.plus.mm4H.rpkm.speLength[,1]\n#HRC.plus.mm4H.rpkm.speLength<-HRC.plus.mm4H.rpkm.speLength[,-1]\nis.na(HRC.plus.mm4H.rpkm.speLength)<-which(HRC.plus.mm4H.rpkm.speLength == 0)\nis.na(mm4.rpkm.speLength)<-which(mm4.rpkm.speLength == 0)\nHRC.plus.mm4H.rpkm.speLength<-cbind(HRC.plus.mm4H.ribo[,1],as.data.frame(HRC.plus.mm4H.rpkm.speLength))\n\n\nHRC.plus.mm4H.rpkm.speLength<-HRC.plus.mm4H.rpkm.speLength[rpkm.filter,]\nmm4.rpkm.speLength<-mm4.rpkm.speLength[rpkm.filter,]\nHRC.plus.mm4H.rpkm.log2<-log2(HRC.plus.mm4H.rpkm.speLength[,-1])\nHRC.plus.mm4H.rpkm.log2$ENSG<-HRC.plus.mm4H.rpkm.speLength[,1]\nribo.primate.logRPKM<-HRC.plus.mm4H.rpkm.log2\n# primate data 2\n\nribo.primate<-exprs(eSetRRP.all.RP[,eSetRRP.all.RP$seqData == \"ribo\"])\nribo.primate.logRPKM<-log2(ribo.primate)\n\n# conver matrix to data frame to merge\n#ribo.primate.logRPKM<-as.data.frame(HRC.plus.mm4H.rpkm.log2)\n#names(ribo.primate.logRPKM)[1]<-c(\"ENSG\")\n\nH.ID<-names(ribo.primate.logRPKM)[grep(\"H\",names(ribo.primate.logRPKM))]\nH.ID<-sub(\"H\",\"\",H.ID)\nH.ID<-sub(\".ribo\",\"\",H.ID)\n#paste(H.ID,collapse = \"|\")\nH.index<-grep(paste(H.ID,collapse = \"|\"),names(ribo.primate.logRPKM))\nYRI.ribo.logRPKM.sub<-YRI.ribo.logRPKM[,-H.index]                      \n\n# normalization\n#YRI.plus.primate.expressed.ribo.log2.QN <- normalizeQuantiles(YRI.plus.primate.expressed.ribo.log2[,2:83])\n#YRI.plus.primate.expressed.ribo.log2.QN$ENSG <- YRI.plus.primate.expressed.ribo.log2$ENSG\nribo.primate.logRPKM.QN<-normalizeQuantiles(ribo.primate.logRPKM[,1:16])\nribo.primate.logRPKM.QN$ENSG<-ribo.primate.logRPKM[,21]\nYRI.ribo.logRPKM.sub.QN<-normalizeQuantiles(YRI.ribo.logRPKM.sub[,1:66])\nYRI.ribo.logRPKM.sub.QN$ENSG<-YRI.ribo.logRPKM.sub[,67]\n#YRI.plus.primate.expressed.ribo.log2<-merge(YRI.ribo.logRPKM.sub,ribo.primate.logRPKM,by = \"ENSG\")\n#YRI.plus.primate.expressed.ribo.log2<-YRI.plus.primate.expressed.ribo.log2[,c(-84:-87)]\nYRI.plus.primate.expressed.ribo.log2<-merge(YRI.ribo.logRPKM.sub.QN,ribo.primate.logRPKM.QN,by = \"ENSG\")\n\n#pca\nread.xls(\"/Users/siddisis/Dropbox/work/Ribosome_profiling/Primate_comparison/primate_ribo_gender_mmbatch.xlsx\")->cell.source\ncell.source<-cell.source[,1:4]\nbatch<-c(rep(\"mm0\",66),as.character(cell.source$libmix))\n\ntemp<-as.matrix(na.omit(YRI.plus.primate.expressed.ribo.log2[,-1]))\npc<-prcomp(t(temp),center = T,scale = T)\n\nbarplot((pc$sdev)^2/sum((pc$sdev)^2), names.arg =  colnames(pc$x))\nspec<-substring(rownames(pc$x),1,1)\ntemp.data<-as.data.frame(cbind(melt(pc$x),pc$x[,1],spec,batch))\nnames(temp.data)<-c(\"ID\",\"PC\",\"value\",\"pc1\",\"species\",\"batch\")\ntemp.data%>% filter(as.numeric(PC) < 13) %>% ggplot(aes(x=pc1,y=value))+geom_point(aes(color = species))+facet_wrap(~PC)\ntemp.data%>% filter(as.numeric(PC) < 13) %>% ggplot(aes(x=pc1,y=value))+geom_point(aes(color = batch))+facet_wrap(~PC)\n\n#sva\n\nlibrary(sva)\nspec<-sub(\"G\",\"H\",substring(names(YRI.plus.primate.expressed.ribo.log2.QN[,-83]),1,1))\n\nspec.design <- model.matrix(~ as.factor(spec))\nmod0 <- model.matrix(~1,data=as.data.frame(t(YRI.plus.primate.expressed.ribo.log2.QN[,-83])))\ntemp<-as.matrix(na.omit(YRI.plus.primate.expressed.ribo.log2.QN[,-83]))\n\nfor (i in 1:20){\n  svobj <- sva(temp,spec.design,mod0,n.sv=i)\n  fsva.obj<-fsva(temp,spec.design,svobj,temp)\n  pc<-prcomp(t(fsva.obj$db[,67:82]),center = T,scale = T)\n  spec<-substring(rownames(pc$x),1,1)\n  plot(pc$x[,1],pc$x[,2],col=as.factor(spec), main=i)\n}  \n\n",
    "created" : 1446411888717.000,
    "dirty" : true,
    "encoding" : "",
    "folds" : "",
    "hash" : "1606224124",
    "id" : "B767A613",
    "lastKnownWriteTime" : -3458764513820540928,
    "path" : null,
    "project_path" : null,
    "properties" : {
        "tempName" : "Untitled8"
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "type" : "r_source"
}